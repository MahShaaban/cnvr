---
title: "Visualizing CNV usign cnvr"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Visualizing CNV usign cnvr}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(cnvr)
library(TxDb.Hsapiens.UCSC.hg38.knownGene)
library(org.Hs.eg.db)
```

```{r read_cnv}
# locate and read cnv file
cnv <- read_cnv(
  system.file('extdata/family.gene.cnv', package = 'cnvr'),
  col_names = c('region', 'numsnp', 'length', 'cn', 'sample', 'startsnp', 'endsnp',
                'conf', 'gene', 'distance')
)
cnv <- cnv[with(cnv, gene != 'NOT_FOUND')]
```

```{r heatmap_png, echo=FALSE, fig.align = 'center', out.width='70%'}
hm <- 'heatmap.png'
png(filename = hm, width = 5, height = 5, units = 'in', res = 300)
plot_heatmap(cnv, column_labels = c('father', 'mother', 'offspring'))
dev.off()
knitr::include_graphics(hm)
```

```{r heatmap, eval=FALSE, fig.align = 'center', out.width='70%'}
plot_heatmap(cnv, column_labels = c('father', 'mother', 'offspring'))
```

```{r subset_cnv}
# cnv
cnv <- cnv[with(cnv, sample == "data-raw/PennCNV/example/offspring.txt" & cn == 1 & gene != 'NOT_FOUND')]
```

```{r gene_model}
# get gene model
txdb <- TxDb.Hsapiens.UCSC.hg38.knownGene::TxDb.Hsapiens.UCSC.hg38.knownGene
org <- org.Hs.eg.db::org.Hs.eg.db
gene <- unlist(strsplit(cnv$gene, ','))
gene_model <- get_genemodel(txdb, org, gene)
```

```{r load_signal}
# load signal
signal <- read_signal(
  system.file('extdata/offspring.txt', package = 'cnvr'),
  col_names = c('name', 'chr', 'pos', 'gt', 'lrr', 'baf')
)
```

```{r load_cytobands}
# read cytobands file
cytobands <- read_cytobands(system.file('extdata/hg38.cytoBand.txt', package = 'cnvr'))
cytobands <- IRanges::subsetByOverlaps(cytobands, cnv)
```

```{r plot_signal_png, echo=FALSE, fig.align = 'center', out.width='70%'}
lrr <- 'lrr.png'
png(filename = lrr, width = 5, height = 5, units = 'in', res = 300)
plot_signal(signal, cnv, flank, type = 'LRR', gene_model, bands = cytobands)
dev.off()
knitr::include_graphics(lrr)

baf <- 'baf.png'
png(filename = baf, width = 5, height = 5, units = 'in', res = 300)
plot_signal(signal, cnv, flank, type = 'BAF', gene_model, bands = cytobands)
dev.off()
knitr::include_graphics(baf)
```

```{r plot_lrr, eval=FALSE, fig.align = 'center', out.width='70%'}
plot_signal(signal, cnv, flank = 200000, type = 'LRR', gene_model, bands = cytobands)
```

```{r plot_baf, eval=FALSE, fig.align = 'center', out.width='70%'}
plot_signal(signal, cnv, flank = 200000, type = 'BAF', gene_model, bands = cytobands)
```
